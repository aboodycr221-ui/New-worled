<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø²Ø§Ø¯ Ø¹Ù„Ù†ÙŠ Ù…Ø¨Ø§Ø´Ø±</title>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#e5e7eb}
header{padding:16px;background:#020617;display:flex;justify-content:space-between}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:#020617;border-radius:18px;padding:16px;margin-bottom:16px;
box-shadow:0 0 20px rgba(56,189,248,.25)}
h3{color:#38bdf8}
input,button{width:100%;padding:12px;margin-top:8px;border-radius:12px;border:none}
button{background:#38bdf8;font-weight:bold;cursor:pointer}
button:disabled{background:#1e293b;color:#64748b}
#chat{max-height:250px;overflow:auto}
.msg{background:#020617;padding:8px;border-radius:10px;margin-bottom:6px}
#countdown{font-size:32px;text-align:center;color:#a78bfa}
img{max-width:100%;border-radius:16px;margin-top:10px}
</style>
</head>

<body>

<header>
  <div>ğŸ”¥ Ù…Ø²Ø§Ø¯ Ù…Ø¨Ø§Ø´Ø±</div>
  <div>Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†: <span id="users">1</span></div>
</header>

<div class="container">

<div class="card">
  <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø²Ø§Ø¯ (ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø²Ø§Ø¯ ÙÙ‚Ø·)</h3>
  <input type="file" id="imageInput">
  <input type="number" id="startPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©">
  <button onclick="createAuction()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø²Ø§Ø¯</button>
  <div id="countdown"></div>
  <img id="auctionImg">
</div>

<div class="card">
  <button id="endBtn" onclick="endAuction()" disabled>Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ø¯</button>
</div>

<div class="card">
  <h3>Ø§Ù„Ø´Ø§Øª / Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø§Øª</h3>
  <div id="chat"></div>
  <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ù…Ø²Ø§ÙŠØ¯Ø©">
  <button onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInAnonymously }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "PUT_YOUR_KEY",
  authDomain: "PUT_YOUR_DOMAIN",
  projectId: "PUT_PROJECT_ID",
  storageBucket: "PUT_BUCKET",
  messagingSenderId: "PUT_ID",
  appId: "PUT_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let uid=null;
let auctionActive=false;
let lastPrice=0;
const auctionRef = doc(db,"auction","main");

signInAnonymously(auth).then(res=>{
  uid=res.user.uid;
});

onSnapshot(collection(db,"chat"),snap=>{
  chat.innerHTML="";
  snap.forEach(d=>{
    const m=document.createElement("div");
    m.className="msg";
    m.textContent=d.data().text;
    chat.appendChild(m);
  });
  chat.scrollTop=9999;
});

onSnapshot(auctionRef,docSnap=>{
  if(!docSnap.exists()) return;
  const d=docSnap.data();
  auctionActive=d.active;
  lastPrice=d.lastPrice;
  if(d.image){
    auctionImg.src=d.image;
  }
  endBtn.disabled = uid!==d.owner || !auctionActive;
});

window.sendMsg=async()=>{
  const val=msgInput.value;
  if(!val) return;

  if(auctionActive && !isNaN(val)){
    if(Number(val)<=lastPrice) return alert("Ù„Ø§Ø²Ù… Ø£Ø¹Ù„Ù‰");
    await updateDoc(auctionRef,{lastPrice:Number(val)});
  }

  await addDoc(collection(db,"chat"),{text:val,time:Date.now()});
  msgInput.value="";
};

window.createAuction=async()=>{
  const file=imageInput.files[0];
  const price=Number(startPrice.value);
  if(!file||!price) return alert("Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø³Ø¹Ø± Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†");

  const r=ref(storage,"auction.jpg");
  await uploadBytes(r,file);
  const url=await getDownloadURL(r);

  await setDoc(auctionRef,{
    owner:uid,
    image:url,
    active:false,
    lastPrice:price
  });

  startCountdown(3,async()=>{
    await updateDoc(auctionRef,{active:true});
    await addDoc(collection(db,"chat"),{text:"ğŸš€ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø¨Ø¯Ø£"});
  });
};

window.endAuction=()=>{
  startCountdown(15,async()=>{
    await updateDoc(auctionRef,{active:false});
    await addDoc(collection(db,"chat"),
    {text:"ğŸ† Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø²Ø§Ø¯ â€” Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: "+lastPrice});
  });
};

function startCountdown(sec,cb){
  countdown.textContent=sec;
  const i=setInterval(()=>{
    sec--;
    countdown.textContent=sec;
    if(sec===0){
      clearInterval(i);
      countdown.textContent="";
      cb();
    }
  },1000);
}
</script>

</body>
</html>
